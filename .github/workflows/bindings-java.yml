name: binding-java

concurrency:
  group: bindings-java-${{ github.head_ref }}
  cancel-in-progress: true

on:
  push:
    branches:
      - master
    paths-ignore:
      - "docs/**"
      - "**.md"
  pull_request:
    branches:
      - master
    paths-ignore:
      - "docs/**"
      - "**.md"

jobs:
  build_ubuntu:
    name: Ubuntu 20.04
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-20.04]
    container:
      image: wasmedge/wasmedge:ubuntu-build-clang

    steps:
      - uses: actions/checkout@v3

      - uses: actions/setup-java@v3
        with:
          distribution: 'temurin' # See 'Supported distributions' for available options
          java-version: '11'

      - name: Setup Gradle
        uses: gradle/gradle-build-action@v2

      - name: Clean up
        run: |
          cd bindings/java/wasmedge-jni/
          rm -f build

      - name: Build & Install WasmEdge
        run: |
          apt-get update
          apt-get install -y make
          mkdir -p build
          cd build
          cmake -DWASMEDGE_BUILD_TESTS=ON ..
          make -j
          make install

      - name: Build & Install WasmEdge JNI
        run: |
          cd bindings/java/wasmedge-jni
          export LD_LIBRARY_PATH="/usr/local/lib"
          mkdir -p build
          cd build
          cmake ..
          make && make install
          ldd libwasmedge_jni.so
          ldd /usr/local/lib/libwasmedge_jni.so
          
      - name: Build WasmEdge Java
        run: |
          export LD_LIBRARY_PATH="/usr/local/lib"
          cd bindings/java/wasmedge-java
          ./gradlew clean 
          ./gradlew assemble

      - name: Run Tests
        run: |
          export LD_LIBRARY_PATH="/usr/local/lib"
          cd bindings/java/wasmedge-java
          ./gradlew test

