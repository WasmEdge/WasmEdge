name: Build and Test WasmEdge on riscv64 arch

concurrency:
  group: build-riscv64-${{ github.head_ref }}
  cancel-in-progress: true

on:
  push:
    branches:
      - "**"
    paths:
      - ".github/workflows/build_for_riscv.yml"
      - "include/**"
      - "lib/**"
      - "test/**"
      - "!test/plugins/**"
      - "thirdparty/**"
      - "tools/**"
      - "CMakeLists.txt"
      - "cmake/**"
  pull_request:
    branches:
      - "**"
      - 'proposal/**'
    paths:
      - ".github/workflows/build_for_riscv.yml"
      - "include/**"
      - "lib/**"
      - "test/**"
      - "!test/plugins/**"
      - "thirdparty/**"
      - "tools/**"
      - "CMakeLists.txt"
      - "cmake/**"

permissions:
  contents: read

jobs:
  # TODO: Refactor `lint` with `on.workflow_run`
  # https://docs.github.com/en/actions/using-workflows/triggering-a-workflow
  lint:
    uses: ./.github/workflows/reusable-call-linter.yml

  cross_compile:
    name: Cross-Compile for RISC-V64
    runs-on: ubuntu-latest
    container: ubuntu:24.04
    needs: lint
    steps:
    - name: Harden the runner (Audit all outbound calls)
      uses: step-security/harden-runner@5ef0c079ce82195b2a36a210272d6b661572d83e # v2.14.2
      with:
        egress-policy: audit

    - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
      with:
        fetch-depth: 0

    - name: Set up riscv64 multi-arch sources
      run: |
        apt-get update
        apt-get install -y --no-install-recommends git ca-certificates
        git config --global --add safe.directory $(pwd)
        dpkg --add-architecture riscv64
        if [ -f /etc/apt/sources.list.d/ubuntu.sources ]; then
          sed -i '/^Types:/a Architectures: amd64' /etc/apt/sources.list.d/ubuntu.sources
        fi
        printf 'Types: deb\nURIs: http://ports.ubuntu.com/ubuntu-ports\nSuites: noble noble-updates\nComponents: main universe\nArchitectures: riscv64\nSigned-By: /usr/share/keyrings/ubuntu-archive-keyring.gpg\n' \
          > /etc/apt/sources.list.d/riscv64-ports.sources
        apt-get update

    - name: Install cross-compilation toolchain
      run: |
        # Install amd64 build tools and riscv64 cross-compiler + zlib
        apt-get install -y --no-install-recommends \
          cmake g++ dpkg-dev make \
          gcc-riscv64-linux-gnu g++-riscv64-linux-gnu \
          zlib1g-dev:riscv64

        # llvm-18-dev:riscv64 cannot be installed via apt-get because its
        # dependency chain pulls in python3.12-minimal:riscv64, whose postinst
        # script tries to execute /usr/bin/python3.12 (a riscv64 binary) on
        # the x86_64 host, causing "Exec format error".
        # Workaround: download the packages and extract without running postinst.
        apt-get install -y -d --no-install-recommends \
          llvm-18-dev:riscv64 liblld-18-dev:riscv64
        for deb in /var/cache/apt/archives/*_riscv64.deb; do
          dpkg-deb -x "$deb" /
        done

    - name: Build WasmEdge
      run: |
        cmake -Bbuild \
          -DCMAKE_TOOLCHAIN_FILE=$(pwd)/cmake/riscv64-linux-gnu.cmake \
          -DCMAKE_BUILD_TYPE=Release \
          -DWASMEDGE_BUILD_TESTS=ON \
          -DWASMEDGE_BUILD_TOOLS=ON \
          -DWASMEDGE_BUILD_SHARED_LIB=ON \
          -DWASMEDGE_USE_LLVM=ON \
          -DLLVM_DIR=/usr/lib/riscv64-linux-gnu/cmake/llvm-18 \
          .
        cmake --build build -j $(nproc)

    - name: Package build artifacts
      run: |
        mkdir -p riscv64-artifacts/build
        cp -a build/tools riscv64-artifacts/build/
        cp -a build/lib riscv64-artifacts/build/
        # Copy the full test directory: executables, test data files, and
        # spec test suites (fetched by FetchContent during CMake configure).
        # Tests expect data files relative to their binary directory.
        cp -a build/test riscv64-artifacts/build/
        # Remove build intermediates to reduce artifact size
        find riscv64-artifacts/build/test -type d -name CMakeFiles -exec rm -rf {} + 2>/dev/null || true
        find riscv64-artifacts/build/test \( -name '*.o' -o -name '*.d' \) -delete 2>/dev/null || true
        tar -czf riscv64-artifacts.tar.gz riscv64-artifacts/

    - name: Upload build artifacts
      uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v6.0.0
      with:
        name: riscv64-build-artifacts
        path: riscv64-artifacts.tar.gz
        retention-days: 1

  test_riscv64:
    name: Test on RISC-V64 (QEMU)
    runs-on: ubuntu-latest
    container: ubuntu:24.04
    needs: cross_compile
    steps:
    - name: Harden the runner (Audit all outbound calls)
      uses: step-security/harden-runner@e3f713f2d8f53843e71c69a996d56f51aa9adfb9 # v2.14.1
      with:
        egress-policy: audit

    - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
      with:
        fetch-depth: 0

    - name: Download build artifacts
      uses: actions/download-artifact@37930b1c2abaa49bbe596cd826c3c89aef350131 # v7.0.0
      with:
        name: riscv64-build-artifacts

    - name: Set up riscv64 runtime environment
      run: |
        dpkg --add-architecture riscv64
        if [ -f /etc/apt/sources.list.d/ubuntu.sources ]; then
          sed -i '/^Types:/a Architectures: amd64' /etc/apt/sources.list.d/ubuntu.sources
        fi
        printf 'Types: deb\nURIs: http://ports.ubuntu.com/ubuntu-ports\nSuites: noble noble-updates\nComponents: main universe\nArchitectures: riscv64\nSigned-By: /usr/share/keyrings/ubuntu-archive-keyring.gpg\n' \
          > /etc/apt/sources.list.d/riscv64-ports.sources
        apt-get update

        # Install QEMU, test utilities, and riscv64 cross-runtime for sysroot
        apt-get install -y --no-install-recommends \
          qemu-user-static tar wabt \
          libc6-riscv64-cross \
          libstdc++6-riscv64-cross \
          libgcc-s1-riscv64-cross \
          libatomic1-riscv64-cross

        # Install riscv64 LLVM/LLD runtime libraries (these do NOT depend on
        # python3:riscv64, so apt-get install works without postinst issues)
        apt-get install -y --no-install-recommends \
          libllvm18:riscv64 \
          liblld-18:riscv64 \
          zlib1g:riscv64

        # Create symlinks so QEMU sysroot can find multi-arch libraries.
        # With -L /usr/riscv64-linux-gnu, QEMU translates guest absolute paths
        # by prepending the sysroot prefix. The kernel resolves symlinks natively,
        # so symlinks pointing outside the sysroot work correctly.
        mkdir -p /usr/riscv64-linux-gnu/usr/lib
        ln -sf /usr/lib/riscv64-linux-gnu /usr/riscv64-linux-gnu/usr/lib/riscv64-linux-gnu
        mkdir -p /usr/riscv64-linux-gnu/lib
        ln -sf /lib/riscv64-linux-gnu /usr/riscv64-linux-gnu/lib/riscv64-linux-gnu

    - name: Extract artifacts and run quick test suite
      run: |
        tar -xzf riscv64-artifacts.tar.gz
        cd riscv64-artifacts

        # =============================================================
        # RISC-V Quick Test Suite
        # =============================================================
        # A focused subset of tests for basic execution verification
        # under QEMU user-mode emulation. Confirms that compilation
        # is sound and fundamental WasmEdge components work correctly
        # within a reasonable time.
        #
        # Tests are categorized into three groups:
        #   1. QUICK  - Fast unit/integration tests (enabled)
        #   2. HEAVY  - Spec-test-based suites, too slow for QEMU (disabled)
        #   3. FLAKY  - Unreliable under QEMU user-mode emulation (disabled)
        # =============================================================

        # --- Group 1: Quick tests (enabled) ---
        # These complete within a reasonable time under QEMU and verify
        # core compilation and fundamental component functionality.
        #
        # Core utilities:
        #   wasmedgeCommonTests            - Common utilities (int128 arithmetic)
        #   wasmedgeErrinfoTests           - Error information handling
        #   expectedTests                  - Expected<T> library tests
        #   poTests                        - Program options parsing
        #   spanTests                      - Span utility tests
        # Loader:
        #   wasmedgeLoaderFileMgrTests     - WASM binary file manager
        #   wasmedgeLoaderASTTests         - WASM AST module loading & parsing
        #   wasmedgeLoaderSerializerTests  - WASM module serialization
        # Validator:
        #   wasmedgeValidatorSubtypeTests  - Validator subtype checking
        # Runtime:
        #   wasmedgeMemLimitTests          - Memory limit enforcement
        #   wasmedgeExternrefTests         - External reference (externref) tests
        #   wasmedgeHostMockTests          - Host module mock tests
        # API:
        #   wasmedgeAPIUnitTests           - Core C API unit tests (types, values, config)
        # AOT:
        #   wasmedgeAOTBlake3Tests         - AOT Blake3 hash tests
        QUICK_TESTS="
          wasmedgeCommonTests
          wasmedgeErrinfoTests
          expectedTests
          poTests
          spanTests
          wasmedgeLoaderFileMgrTests
          wasmedgeLoaderASTTests
          wasmedgeLoaderSerializerTests
          wasmedgeValidatorSubtypeTests
          wasmedgeMemLimitTests
          wasmedgeExternrefTests
          wasmedgeHostMockTests
          wasmedgeAPIUnitTests
          wasmedgeAOTBlake3Tests
        "

        # --- Group 2: Time-consuming tests (disabled) ---
        # These tests run the full WebAssembly spec test suites
        # (wasm-1.0 through wasm-3.0 + proposals: bulk-memory,
        # exceptions, GC, multi-memory, relaxed-simd, simd, threads)
        # through various execution paths. Under QEMU emulation each
        # can take 30+ minutes. Re-enable when native RISC-V CI
        # runners are available.
        #
        # wasmedgeExecutorCoreTests       - Executor + full spec test suites
        # wasmedgeAPIVMCoreTests          - VM API + full spec test suites
        # wasmedgeAPIStepsCoreTests       - Step-by-step exec + spec suites
        # wasmedgeAPIAOTCoreTests         - AOT compilation + spec test suites
        # wasmedgeAPIAOTNestedVMTests     - Nested VM + AOT + spec suites
        # wasmedgeLLVMCoreTests           - LLVM backend + full spec test suites
        # wasmedgeAOTCacheTests           - AOT cache (requires LLVM compilation)
        # wasmedgeMixcallTests            - Mixed AOT/interpreter call interop
        # componentTests                  - Component model spec test suites

        # --- Group 3: Expected-to-fail tests (disabled) ---
        # These tests are unreliable under QEMU user-mode emulation
        # due to platform or emulation limitations.
        #
        # wasmedgeThreadTests             - QEMU user-mode does not reliably
        #                                   emulate multi-threaded atomics
        # wasiTests                       - WASI filesystem/process behavior
        #                                   differs under QEMU cross-arch sysroot
        # wasiSocketTests                 - Network stack not fully functional
        #                                   in QEMU user-mode emulation

        failed=0
        for test_name in ${QUICK_TESTS}; do
          # Locate the test binary under the build tree
          test_bin=$(find build/test -type f -executable -name "${test_name}" 2>/dev/null | head -1)
          if [ -z "${test_bin}" ]; then
            echo "SKIP: ${test_name} (binary not found)"
            continue
          fi
          echo "=== Running: ${test_name} ==="
          test_dir=$(dirname "${test_bin}")
          # Compute relative path from the test's directory to build/lib
          # so LD_LIBRARY_PATH stays relative (QEMU translates absolute paths).
          REL_LIB=$(realpath --relative-to="${test_dir}" build/lib)
          # Run from the test binary's directory: tests expect data files
          # (filemgrTestData/, externrefTestData/, etc.) relative to cwd.
          if ( cd "${test_dir}" && timeout 300 qemu-riscv64-static \
            -L /usr/riscv64-linux-gnu \
            -E LD_LIBRARY_PATH=/usr/lib/riscv64-linux-gnu:${REL_LIB} \
            "./${test_name}" ); then
            echo "PASSED: ${test_name}"
          else
            echo "FAILED: ${test_name}"
            failed=$((failed + 1))
          fi
        done
        echo "=== Quick Test Suite Complete ==="
        if [ "${failed}" -gt 0 ]; then
          echo "${failed} test(s) failed"
          exit 1
        fi
        echo "All quick tests passed"

    - name: Verify WasmEdge CLI tools
      run: |
        cd riscv64-artifacts
        qemu-riscv64-static \
          -L /usr/riscv64-linux-gnu \
          -E LD_LIBRARY_PATH=/usr/lib/riscv64-linux-gnu:build/lib \
          build/tools/wasmedge/wasmedge -v
        cd ../examples/wasm
        wat2wasm fibonacci.wat -o fibonacci.wasm
        qemu-riscv64-static \
          -L /usr/riscv64-linux-gnu \
          -E LD_LIBRARY_PATH=/usr/lib/riscv64-linux-gnu:../../riscv64-artifacts/build/lib \
          ../../riscv64-artifacts/build/tools/wasmedge/wasmedge --reactor fibonacci.wasm fib 30