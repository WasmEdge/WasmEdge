name: Build extensions

on:
  workflow_call:
    inputs:
      version:
        type: string
        required: true
      release:
        type: boolean
        default: false

permissions:
  contents: read

jobs:
  # ------------------------------------------------------------------#
  # The list of build targets is in the file:
  #     .github/workflows/matrix-extensions.json
  #
  # 'paths-filter' example:
  #
  #   wasi_nn:
  #     - paths/to/wasi_nn
  #     - other/paths/to/wasi_nn
  #
  # plugin: 'wasi_nn-ggml'
  #
  #   process.env['wasi_nn'] => true
  #   process.env['wasi_nn-ggml'] => undefined
  # ------------------------------------------------------------------#
  prepare:
    name: Prepare ${{ inputs.asset_tag }}
    runs-on: ubuntu-latest
    outputs:
      ubuntu_matrix: ${{ steps.prepare.outputs.ubuntu_matrix }}
      ubuntu_latest_matrix: ${{ steps.prepare.outputs.ubuntu_latest_matrix }}
      macos_matrix: ${{ steps.prepare.outputs.macos_matrix }}
      manylinux_matrix: ${{ steps.prepare.outputs.manylinux_matrix }}
    steps:
      - name: Harden the runner (Audit all outbound calls)
        uses: step-security/harden-runner@5ef0c079ce82195b2a36a210272d6b661572d83e # v2.14.2
        with:
          egress-policy: audit

      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
        with:
          fetch-depth: 0
      - id: filter
        uses: dorny/paths-filter@de90cc6fb38fc0963ad72b210f1f284cd68cea36 # v3.0.2
        with:
          filters: '.github/extensions.paths-filter.yml'
      - id: readfile
        uses: actions/github-script@ed597411d8f924073f98dfc5c65a23a2325f34cd # v8.0.0
        with:
          result-encoding: string
          script: |
            const fs = require("fs")
            const s = fs.readFileSync(".github/workflows/matrix-extensions.json")
            let plugins = JSON.parse(s).plugins
            if (!${{ inputs.release || fromJSON(steps.filter.outputs.all) }}) {
              plugins = plugins.filter(
                (plugin) => !(
                  process.env[plugin.plugin] != 'true' &&
                  process.env[plugin.plugin.split('-')[0]] != 'true')
              )
            }
            let asset_tags = [
              "macos_x86_64",
              "macos_arm64",
              "manylinux_2_28_x86_64",
              "manylinux_2_28_aarch64",
              "ubuntu2004_x86_64",
              "ubuntu2004_cuda11",
              "ubuntu2004_cuda12",
              "ubuntu_latest",
            ]

            const pluginsForPlatform = (platform) =>
            plugins.filter(p => p.platforms.includes(platform))
              .map(p => {
                const copy = { ...p }
                delete copy.platforms
                return copy
              })
            # for (const tag of asset_tags) {
            #   core.setOutput(tag, plugins.filter(
            #     (plugin) => plugin.platforms.includes(tag)
            #   ).map((plugin) => {
            #     let copy = { ...plugin }
            #     delete copy.platforms
            #     return copy
            #   }))
            # }

            const platformPlugins = {
            ubuntu2004_x86_64:  pluginsForPlatform("ubuntu2004_x86_64"),
            ubuntu2004_cuda11:  pluginsForPlatform("ubuntu2004_cuda11"),
            ubuntu2004_cuda12:  pluginsForPlatform("ubuntu2004_cuda12"),
            ubuntu_latest:      pluginsForPlatform("ubuntu_latest"),
            macos_x86_64:       pluginsForPlatform("macos_x86_64"),
            macos_arm64:        pluginsForPlatform("macos_arm64"),
            manylinux_x86_64:   pluginsForPlatform("manylinux_2_28_x86_64"),
            manylinux_aarch64: pluginsForPlatform("manylinux_2_28_aarch64"),
            }

            const buildMatrix = (variants) =>
            variants
              .filter(v => v.plugins.length > 0)
              .map(v => ({
                runner: v.runner,
                docker_tag: v.docker_tag,
                asset_tag: v.asset_tag,
                plugins: v.plugins,
              }))

              // --------------------------------------------------
             // Ubuntu 20.04 variants
            // --------------------------------------------------
           const ubuntuVariants = [
            {
              runner: "ubuntu-latest",
              docker_tag: "ubuntu-20.04-build-clang-plugins-deps",
              asset_tag: "ubuntu20.04_x86_64",
              plugins: platformPlugins.ubuntu2004_x86_64,
            },
            {
              runner: "ubuntu-latest",
              docker_tag: "ubuntu-20.04-build-gcc-cuda11",
              asset_tag: "ubuntu20.04_x86_64",
              plugins: platformPlugins.ubuntu2004_cuda11,
            },
            {
              runner: "ubuntu-latest",
              docker_tag: "ubuntu-20.04-build-gcc-cuda12",
              asset_tag: "ubuntu20.04_x86_64",
              plugins: platformPlugins.ubuntu2004_cuda12,
            },
            ]

            // --------------------------------------------------
            // Ubuntu latest variants
            // --------------------------------------------------
            const ubuntuLatestVariants = [
            {
              runner: "ubuntu-latest",
              docker_tag: "ubuntu-24.04-build-clang-plugins-deps",
              asset_tag: "ubuntu24.04-clang",
              plugins: platformPlugins.ubuntu_latest,
            },
            {
              runner: "ubuntu-latest",
              docker_tag: "ubuntu-24.04-build-gcc-plugins-deps",
              asset_tag: "ubuntu24.04-gcc",
              plugins: platformPlugins.ubuntu_latest,
            },
            ]

            // --------------------------------------------------
            // macOS variants
            // --------------------------------------------------
            const macosVariants = [
            {
              runner: "macos-15-intel",
              asset_tag: "darwin_24-x86_64",
              plugins: platformPlugins.macos_x86_64,
            },
            {
              runner: "macos-14",
              asset_tag: "darwin_23-arm64",
              plugins: platformPlugins.macos_arm64,
            },
            ]

            // --------------------------------------------------
            // manylinux variants
            // --------------------------------------------------
            const manylinuxVariants = [
            {
              runner: "ubuntu-latest",
              docker_tag: "manylinux_2_28_x86_64-plugins-deps",
              asset_tag: "manylinux_2_28_x86_64",
              plugins: platformPlugins.manylinux_x86_64,
            },
            {
              runner: "ubuntu-24.04-arm",
              docker_tag: "manylinux_2_28_aarch64-plugins-deps",
              asset_tag: "manylinux_2_28_aarch64",
              plugins: platformPlugins.manylinux_aarch64,
            },
            ]

            // --------------------------------------------------
            // Build matrices
            // --------------------------------------------------
            const ubuntuMatrix       = buildMatrix(ubuntuVariants)
            const ubuntuLatestMatrix = buildMatrix(ubuntuLatestVariants)
            const macosMatrix        = buildMatrix(macosVariants)
            const manylinuxMatrix    = buildMatrix(manylinuxVariants)

            // --------------------------------------------------
            // Outputs
            // --------------------------------------------------
            core.setOutput("ubuntu_matrix", JSON.stringify(ubuntuMatrix))
            core.setOutput("ubuntu_latest_matrix", JSON.stringify(ubuntuLatestMatrix))
            core.setOutput("macos_matrix", JSON.stringify(macosMatrix))
            core.setOutput("manylinux_matrix", JSON.stringify(manylinuxMatrix))

        env:
          wasi_crypto: ${{ steps.filter.outputs.wasi_crypto }}
          wasi_nn: ${{ steps.filter.outputs.wasi_nn }}
          wasm_bpf: ${{ steps.filter.outputs.wasm_bpf }}
          wasmedge_ffmpeg: ${{ steps.filter.outputs.wasmedge_ffmpeg }}
          wasmedge_image: ${{ steps.filter.outputs.wasmedge_image }}
          wasmedge_llmc: ${{ steps.filter.outputs.wasmedge_llmc }}
          wasmedge_opencvmini: ${{ steps.filter.outputs.wasmedge_opencvmini }}
          wasmedge_process: ${{ steps.filter.outputs.wasmedge_process }}
          wasmedge_stablediffusion: ${{ steps.filter.outputs.wasmedge_stablediffusion }}
          wasmedge_tensorflow: ${{ steps.filter.outputs.wasmedge_tensorflow }}
          wasmedge_tensorflowlite: ${{ steps.filter.outputs.wasmedge_tensorflowlite }}
          wasmedge_zlib: ${{ steps.filter.outputs.wasmedge_zlib }}

  build_on_ubuntu:
    needs: prepare
    permissions:
      contents: write # Required by reusable-build-extensions-on-linux.yml
    strategy:
      fail-fast: false
      matrix:
        include:
          - runner: 'ubuntu-latest'
            docker_tag: 'ubuntu-20.04-build-clang-plugins-deps'
            asset_tag: 'ubuntu20.04_x86_64'
            plugins: ${{ needs.prepare.outputs.ubuntu2004_x86_64 }}
          - runner: 'ubuntu-latest'
            docker_tag: 'ubuntu-20.04-build-gcc-cuda11'
            asset_tag: 'ubuntu20.04_x86_64'
            plugins: ${{ needs.prepare.outputs.ubuntu2004_cuda11 }}
          - runner: 'ubuntu-latest'
            docker_tag: 'ubuntu-20.04-build-gcc-cuda12'
            asset_tag: 'ubuntu20.04_x86_64'
            plugins: ${{ needs.prepare.outputs.ubuntu2004_cuda12 }}
    name: ${{ matrix.asset_tag }}
    uses: ./.github/workflows/reusable-build-extensions-on-linux.yml
    with:
      runner: ${{ matrix.runner }}
      docker_tag: ${{ matrix.docker_tag }}
      asset_tag: ${{ matrix.asset_tag }}
      plugins: ${{ matrix.plugins }}
      version: ${{ inputs.version }}
      release: ${{ inputs.release }}
    secrets: inherit

  build_on_ubuntu_latest:
    if: ${{ !inputs.release }}
    needs: prepare
    permissions:
      contents: write # Required by reusable-build-extensions-on-linux.yml
    strategy:
      fail-fast: false
      matrix:
        include:
          - runner: 'ubuntu-latest'
            docker_tag: 'ubuntu-24.04-build-clang-plugins-deps'
            asset_tag: 'ubuntu24.04-clang'
            plugins: ${{ needs.prepare.outputs.ubuntu_latest }}
          - runner: 'ubuntu-latest'
            docker_tag: 'ubuntu-24.04-build-gcc-plugins-deps'
            asset_tag: 'ubuntu24.04-gcc'
            plugins: ${{ needs.prepare.outputs.ubuntu_latest }}
    name: ${{ matrix.asset_tag }}
    uses: ./.github/workflows/reusable-build-extensions-on-linux.yml
    with:
      runner: ${{ matrix.runner }}
      docker_tag: ${{ matrix.docker_tag }}
      asset_tag: ${{ matrix.asset_tag }}
      plugins: ${{ matrix.plugins }}
      version: ${{ inputs.version }}
      release: false
    secrets: inherit

  build_on_macos:
    needs: prepare
    permissions:
      contents: write # Required by reusable-build-extensions-on-macos.yml
    strategy:
      fail-fast: false
      matrix:
        include:
          - runner: 'macos-15-intel'
            asset_tag: 'darwin_24-x86_64'
            plugins: ${{ needs.prepare.outputs.macos_x86_64 }}
          - runner: 'macos-14'
            asset_tag: 'darwin_23-arm64'
            plugins: ${{ needs.prepare.outputs.macos_arm64 }}
    name: ${{ matrix.asset_tag }}
    uses: ./.github/workflows/reusable-build-extensions-on-macos.yml
    with:
      runner: ${{ matrix.runner }}
      asset_tag: ${{ matrix.asset_tag }}
      plugins: ${{ matrix.plugins }}
      version: ${{ inputs.version }}
      release: ${{ inputs.release }}
    secrets: inherit

  build_on_manylinux:
    needs: prepare
    permissions:
      contents: write # Required by reusable-build-extensions-on-linux.yml
    strategy:
      fail-fast: false
      matrix:
        include:
          - runner: 'ubuntu-latest'
            docker_tag: 'manylinux_2_28_x86_64-plugins-deps'
            asset_tag: 'manylinux_2_28_x86_64'
            plugins: ${{ needs.prepare.outputs.manylinux_2_28_x86_64 }}
          - runner: 'ubuntu-24.04-arm'
            docker_tag: 'manylinux_2_28_aarch64-plugins-deps'
            asset_tag: 'manylinux_2_28_aarch64'
            plugins: ${{ needs.prepare.outputs.manylinux_2_28_aarch64 }}
    name: ${{ matrix.asset_tag }}
    uses: ./.github/workflows/reusable-build-extensions-on-linux.yml
    with:
      runner: ${{ matrix.runner }}
      docker_tag: ${{ matrix.docker_tag }}
      asset_tag: ${{ matrix.asset_tag }}
      plugins: ${{ matrix.plugins }}
      version: ${{ inputs.version }}
      release: ${{ inputs.release }}
    secrets: inherit
