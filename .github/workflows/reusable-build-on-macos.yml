name: Build on MacOS

on:
  workflow_call:
    inputs:
      version:
        type: string
        required: true
      matrix: # [ { name, runner, darwin_version }, ... ]
        type: string
        required: true
      release:
        type: boolean

permissions:
  contents: read

jobs:
  build_on_macos:
    permissions:
      contents: write
    strategy:
      fail-fast: false
      matrix:
        include: ${{ fromJSON(inputs.matrix) }}
    name: ${{ matrix.name }}
    runs-on: ${{ matrix.runner }}
    env:
      BUILD_TESTS: ON
      BUILD_TYPE: Debug
    steps:
      - name: Harden the runner (Audit all outbound calls)
        uses: step-security/harden-runner@5ef0c079ce82195b2a36a210272d6b661572d83e # v2.14.2
        with:
          egress-policy: audit

      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
        with:
          fetch-depth: 0
      - name: Ensure git safe directory
        run: |
          git config --global --add safe.directory $(pwd)
      - name: Setup build environment - non-release
        if: ${{ !inputs.release }}
        run: |
          echo "BREW_PREFIX=$(brew --prefix)" >> $GITHUB_ENV
          brew uninstall cmake # conflict with the one used by WasmEdge/llvm/lld
          brew tap WasmEdge/llvm
      - name: Install Homebrew tools - non-release
        if: ${{ !inputs.release }}
        run: |
          brew install llvm ninja wabt grpc
      - name: Get lld version
        if: ${{ !inputs.release }}
        id: lld-version-non-release
        run: |
          VERSION=$(brew info --json WasmEdge/llvm/lld | jq -r '.[0].versions.stable')
          echo "version=${VERSION}" >> $GITHUB_OUTPUT
      - name: Cache lld and cmake - non-release
        if: ${{ !inputs.release }}
        id: cache-lld-non-release
        uses: actions/cache@cdf6c1fa76f9f475f3d7449005a359c84ca0f306 # v5.0.3
        with:
          path: |
            ${{ env.BREW_PREFIX }}/Cellar/lld
            ${{ env.BREW_PREFIX }}/Cellar/cmake
          key: homebrew-cellar-lld-${{ runner.os }}-${{ matrix.arch }}-${{ steps.lld-version-non-release.outputs.version }}-${{ hashFiles('.github/workflows/reusable-build-on-macos.yml') }}
          restore-keys: |
            homebrew-cellar-lld-${{ runner.os }}-${{ matrix.arch }}-${{ steps.lld-version-non-release.outputs.version }}-
            homebrew-cellar-lld-${{ runner.os }}-${{ matrix.arch }}-
      - name: Install or link lld and cmake - non-release
        if: ${{ !inputs.release }}
        run: |
          if [ "${{ steps.cache-lld-non-release.outputs.cache-hit }}" != "true" ]; then
            brew install --build-from-source WasmEdge/llvm/lld
          fi
          brew link lld || true
          brew link cmake || true
      - name: Setup build environment - release
        if: ${{ inputs.release }}
        run: |
          echo "BREW_PREFIX=$(brew --prefix)" >> $GITHUB_ENV
          brew uninstall cmake # conflict with the one used by WasmEdge/llvm/lld
          brew tap WasmEdge/llvm
      - name: Install Homebrew tools - release
        if: ${{ inputs.release }}
        run: |
          brew install llvm ninja wabt
      - name: Get lld version
        if: ${{ inputs.release }}
        id: lld-version-release
        run: |
          VERSION=$(brew info --json WasmEdge/llvm/lld | jq -r '.[0].versions.stable')
          echo "version=${VERSION}" >> $GITHUB_OUTPUT
      - name: Cache lld and cmake - release
        if: ${{ inputs.release }}
        id: cache-lld-release
        uses: actions/cache@cdf6c1fa76f9f475f3d7449005a359c84ca0f306 # v5.0.3
        with:
          path: |
            ${{ env.BREW_PREFIX }}/Cellar/lld
            ${{ env.BREW_PREFIX }}/Cellar/cmake
          key: homebrew-cellar-lld-${{ runner.os }}-${{ matrix.arch }}-${{ steps.lld-version-release.outputs.version }}-${{ hashFiles('.github/workflows/reusable-build-on-macos.yml') }}
          restore-keys: |
            homebrew-cellar-lld-${{ runner.os }}-${{ matrix.arch }}-${{ steps.lld-version-release.outputs.version }}-
            homebrew-cellar-lld-${{ runner.os }}-${{ matrix.arch }}-
      - name: Install or link lld and cmake - release
        if: ${{ inputs.release }}
        run: |
          if [ "${{ steps.cache-lld-release.outputs.cache-hit }}" != "true" ]; then
            brew install --build-from-source WasmEdge/llvm/lld
          fi
          brew link lld || true
          brew link cmake || true
      - name: Set environment variables for release
        if: ${{ inputs.release }}
        run: |
          echo "BUILD_TESTS=OFF" | tee -a $GITHUB_ENV
          echo "BUILD_TYPE=Release" | tee -a $GITHUB_ENV
      - name: Build WasmEdge
        run: |
          export CC=clang
          export CXX=clang++
          rm -rf build output
          mkdir -p output
          cmake -Bbuild -GNinja -DCMAKE_BUILD_TYPE=$BUILD_TYPE \
            -DLLVM_DIR:PATH="$(brew --prefix)/opt/llvm/lib/cmake/llvm" \
            -DLLD_DIR:PATH="$(brew --prefix)/opt/lld/lib/cmake/lld" \
            -DWASMEDGE_BUILD_TESTS=$BUILD_TESTS \
            -DWASMEDGE_LINK_LLVM_STATIC=ON \
            -DWASMEDGE_BUILD_PACKAGE="TGZ" \
            -DCMAKE_INSTALL_PREFIX:PATH=$GITHUB_WORKSPACE/output .
          cmake --build build
      - name: Test WasmEdge
        run: |
          export DYLD_LIBRARY_PATH="$(pwd)/build/lib/api:$DYLD_LIBRARY_PATH"
          cd build
          ctest
      - name: Create package tarball
        run: |
          cmake --build build --target package
      - name: Test Standalone WasmEdge without LLVM
        run: |
          export DYLD_LIBRARY_PATH="$(pwd)/build/lib/api:$DYLD_LIBRARY_PATH"
          echo "otool -L ./build/tools/wasmedge/wasmedge:"
          otool -L ./build/tools/wasmedge/wasmedge
          echo "otool -L ./build/tools/wasmedge/wasmedgec:"
          otool -L ./build/tools/wasmedge/wasmedgec
          echo "otool -L ./build/lib/api/libwasmedge.dylib:"
          otool -L ./build/lib/api/libwasmedge.dylib
          if otool -L ./build/lib/api/libwasmedge.dylib | grep libLLVM; then echo "Fail: libLLVM shared library linked" && exit 1; else echo "Pass: libLLVM shared library not linked"; fi;

          echo "Generate fibonacci.wasm from fibonacci.wat"
          wat2wasm examples/wasm/fibonacci.wat -o examples/wasm/fibonacci.wasm
          echo "./build/tools/wasmedge/wasmedgec examples/wasm/fibonacci.wasm fib_c.dylib"
          ./build/tools/wasmedge/wasmedgec examples/wasm/fibonacci.wasm fib_c.dylib
          echo "./build/tools/wasmedge/wasmedge --reactor fib_c.dylib fib 20"
          ./build/tools/wasmedge/wasmedge --reactor fib_c.dylib fib 20
          echo "./build/tools/wasmedge/wasmedge compile examples/wasm/fibonacci.wasm fib_compile.dylib"
          ./build/tools/wasmedge/wasmedge compile examples/wasm/fibonacci.wasm fib_compile.dylib
          echo "./build/tools/wasmedge/wasmedge --reactor fib_compile.dylib fib 20"
          ./build/tools/wasmedge/wasmedge --reactor fib_compile.dylib fib 20
      - name: Check symbol exposure
        run: |
          bash .github/scripts/check_symbols.sh
      - name: Upload artifact
        if: ${{ !inputs.release }}
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v6.0.0
        with:
          name: WasmEdge-${{ inputs.version }}-darwin_${{ matrix.darwin_version }}_${{ matrix.arch }}.tar.gz
          path: build/WasmEdge-${{ inputs.version }}-Darwin.tar.gz
      - name: Upload package tarball
        if: ${{ inputs.release }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          mv build/WasmEdge-${{ inputs.version }}-Darwin.tar.gz WasmEdge-${{ inputs.version }}-darwin_${{ matrix.arch }}.tar.gz
          gh release upload ${{ inputs.version }} WasmEdge-${{ inputs.version }}-darwin_${{ matrix.arch }}.tar.gz --clobber
